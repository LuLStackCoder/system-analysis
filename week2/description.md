# Описание event-storming

<iframe width="768" height="432" src="https://miro.com/app/embed/uXjVMI-SPHE=/?pres=1&frameId=3458764555096272425&embedId=849884180990" frameborder="0" scrolling="no" allow="fullscreen; clipboard-read; clipboard-write" allowfullscreen></iframe>

Контекст наема новых воркеров:
Отдельный контекст, необходимый для наема новых воркеров.
Здесь менеджеры создают/изменяют/удаляют тесты, перебирают существующие заявки, ассайнят тесты на кандидатов-воркеров.
Также Accept/Decline-ят кандидатов. И только после чего воркеры попадают в общий пул.

Контекст ордеринга:
В нем происходит обработка заказов клиентов, отсюда заказы попадают в контекст матчинга. Контролируется смена статусов заказов.
Смена статусов влияет на другие контексты такие как: инвенторинг и биллинг.

Контекст матчинга:
У созданных заказов должен появиться исполнитель. В данном контексте ассайнится воркер на определенный заказ и определяется цена на заказ.

Контекст инветоринга:
Когда заказы переходят в активный статус, работники склада должны собрать расходники под определенный заказ.
В данном контексте определяется эмплоер под каждый заказ, после чего заказ собирается, также в этом контексте должны обратиться к внешнему сервису доставки печенья.

Контекст биллинга:
Данный контекст контроллирует выплаты работникам и списания клиентов.
За каждый заказ перешедший в состояние активный, мы назначаем инвойс клиенту, которую списываем в конце биллинг цикла клиентов(неделя).
Каждый месяц мы назначаем инвойс воркерам исходя из их истории выполненных/зафейленных заказов. 
После того как инвойс создан обращается к стороннему сервису банка для физической выплаты и отсылаем платежку.  
Также в данном контексте менеджеры могут назначить награды воркерам.
После того как ставка переходит в состояние закрытой происходит выплата менеджерам.

Контекст ставок:
В данном контексте менеджеры могут создать ставки и закрыть их.

Контекст качества заказов:
Вся история заказов попадает в этот контекст для того, чтобы менеджеры могли исследовать любой заказ.

# Модель данных

![models.png](models.png)

# Схема сервисов

![services.png](services.png)

Для более корректной разбиении логики была выбраны микросервисная архитектура.
Изначально рассматривал именно микросервисную архитектуру, так как контексты разбиваются так, что можно избежать распределенные транзакции.

Для аутентификации в системе используется отдельный сервис IAM, хранящий роли и умеющий в SSO.


Сервис Hiring-а:
Имеет Manager-API для CUD над тестами, просмотра истории заявок и просмотра информации о кандидатах, ассайна тестов и Accept/Decline кандидатов.
Public-API для приема заявок и прохождения заассайненных тестов.

После Accept кандидата помещает в очередь бизнес-эвент, что появился новый воркер. В IAM создается новая учетка (сохраняются данные об учетке, шлются креды и тд) в сервис Matching-а читает информацию и создает и по ней создает характеристику. Сервис биллинга создает платежный аккаунт.


Сервис Ordering-а:
В нем клиенты добавляют/отменяют заказы, и он контролирует их выполнение, паблишит изменение статусов каждого заказа.


Сервис Matching:
Читает события сервиса Order-ов и хранит ее (может не полностью). Также хранит информацию о характеристиках воркеров. На основе всей этой информации производит матчинг между заказами и воркерами. Паблишит события на ассайн, которые читает ордер сервис для обновления статуса заказа.


Сервис Inventory:
Читает заказы и контроллирует сборку расходников под заказ. Ходит синхронно в сторонний сервис за заказом печенек.


Сервис Billing:
Хранит платежный аккаунт воркеров и клиентов. Читает историю изменения заказов для создания операций, по которым будет создаваться инвойсы и производиться выплаты. Производит выплаты по окончанию биллинг циклов.
Также имеет Manager-API для выплаты авардов от менеджеров для воркеров.


Сервис Bet:
Позволяет менеджерам делать ставки на активные заказы. Синхронно ходит сервис ордеров для получения активных заказов и в биллинг для выплат/списаний менеджерам.

Сервис качества заказов:
Читает события из сервиса заказов и хранит их историю для менеджеров. Ходит в сервис матчинга, например для изменения характеристик воркеров.


Mail сервис:
Обертка на SMTP, ходят все сервисы, которым надо делать нотификации.
